$(document).ready((function(){var e=0,n={hmcsuccess:!1,init:function(){n.form.init();var e=$.cookie("submail_account");e&&$("#login-form-password").find("input[name=account]").val(e)},form:{init:function(){n.hmc.init($("#passward-hmc mdi-hmc")),$("#login-form-password").validate({rules:{account:{required:!0,email:!0},password:{required:!0,minlength:3,maxlength:255}},messages:{account:{required:" ",email:" "},password:{required:"请输入密码",minlength:"请输入密码",maxlength:"请输入密码"}},invalidHandler:function(){return!1},submitHandler:function(){return n.hmcsuccess?n.do_login():$("#passward-hmc mdi-hmc").hmc("focus"),!1}})}},hmc:{init:function(e){e.hmc({init:function(){n.hmcsuccess=!1},callback:function(){n.hmcsuccess=!0}})}},do_login:function(){$("#login-form-password").find("button[type=submit]").spinner({text:"正在登录 ...",type:"grow",size:"s",color:"#fff",disabled:!0,roll_back_text:"登录"});var e=$("#login-form-password").find("input[name=account]").val(),t=$("#login-form-password").find("input[name=password]").val(),i=$.cookie("bd_vid");$(".type-0").find(".error-message").empty(),$.post("/console/api/account/login",{account:e,password:t,bd_vid:i,tim:Math.random()},(function(e){"success"==e.status?($.cookie("submail_account",e.account),$.cookie("last_login_at",e.last_login_at),"true"==e.verify?(n.safeform.mob=e.mob,n.safeform.init()):n.redirect()):(e.type?($(".type-0").find(".error-message").html('<i class="mdi-icon-warning"></i> '+e.message),"timeout"==e.type||"hmc"==e.type?$("mdi-hmc").hmc("timeout"):($("#login-form-password").find("input[name=account]").addClass("form-error"),$("#login-form-password").find("input[name=password]").addClass("form-error"),$("#login-form-password").find("input[name=account]").parent().addClass("shake"),$("#login-form-password").find("input[name=password]").parent().addClass("shake"),setTimeout((()=>{$("#login-form-password").find("input[name=account]").parent().removeClass("shake"),$("#login-form-password").find("input[name=password]").parent().removeClass("shake")}),500),$("mdi-hmc").hmc("reset"))):$.dialog.alert({type:"warning",title:"抱歉！发生了一个错误",content:e.message}),$("#login-form-password").find("button[type=submit]").spinner("destory"))}))},redirect:function(){null!=redirct_url&&""!=redirct_url?window.location=redirct_url:window.location="/console/welcome"},safeform:{nums:["1","2","3","4","5","6","7","8","9","0"],currentIndex:0,mob:"",timer:null,countdown:60,init:function(){this.send();var e=this;$(".login-form-content").hide(),$(".safe-form-content").show(),$(".mobile-text b").text(` +86 ${this.mob}`),$("#verify-safe-form input[data-index=0]").focus(),$("#verify-safe-form input").on("input",(function(n){var t=n.target.value;if(6!=t.length){if(t.length>1){var i=t.substr(-1);e.nums.includes(i)||(i=""),$(`#verify-safe-form input[data-index=${e.currentIndex}]`).val(i),e.next()}else if(1==t.length){if(!e.nums.includes(t))return void $(`#verify-safe-form input[data-index=${e.currentIndex}]`).val("");$(`#verify-safe-form input[data-index=${e.currentIndex}]`).val(t),e.next()}}else{for(var o=!0,s=0;s<6;s++)e.nums.includes(t[s])||(o=!1);o&&($("#verify-safe-form input[data-index=0]").val(t[0]),$("#verify-safe-form input[data-index=1]").val(t[1]),$("#verify-safe-form input[data-index=2]").val(t[2]),$("#verify-safe-form input[data-index=3]").val(t[3]),$("#verify-safe-form input[data-index=4]").val(t[4]),$("#verify-safe-form input[data-index=5]").val(t[5]))}})),$("#verify-safe-form input").on("focus",(function(n){e.currentIndex=$(this).data("index")})),window.addEventListener("keydown",this.onKeyDown)},next:function(){var e=this,n=this.getInputVal();this.currentIndex>=5?6==n.length&&this.do_safe():$(`#verify-safe-form input[data-index=${this.currentIndex+1}]`).focus(),6==n.length?$(".safe-btn").addClass("active").on("click",(function(){e.do_safe()})):$(".safe-btn").removeClass("active").off("click")},before:function(){this.currentIndex<=0?this.currentIndex=0:$(`#verify-safe-form input[data-index=${this.currentIndex-1}]`).focus()},onKeyDown:function(e){switch(e.keyCode){case 8:$(`#verify-safe-form input[data-index=${n.safeform.currentIndex}]`).val()||n.safeform.before();break;case 13:6==n.safeform.getInputVal().length&&n.safeform.do_safe()}},getInputVal:function(){for(var e="",n=0;n<=5;n++)e+=$(`#verify-safe-form input[data-index=${n}]`).val();return e},send:function(){var e=this;$(".re-send").text("正在发送...").removeClass("active"),$.post("/console/api/account/send_login_verify_code",{tim:Math.random()},(function(n){"success"==n.status?(e.countdown=60,e.set_coundown()):"error"==n.status?($(".safe-form-content").find(".error-message").html('<i class="mdi-icon-warning"></i> '+n.message),$(".re-send").text("")):$.dialog.alert({type:"warning",title:"抱歉！发生了一个错误",content:n.message})}))},set_coundown:function(){var e=this;this.timer=setTimeout((()=>{e.countdown<1?($(".re-send").text("重新获取验证码").removeAttr("disabled").addClass("active").on("click",(function(){e.send()})),e.countdown=60):($(".re-send").text(e.countdown+" 秒后可重新获取验证码").removeClass("active"),e.countdown--,e.set_coundown())}),1e3)},do_safe:function(){$(".safe-btn").spinner({text:"正在验证 ...",type:"grow",size:"s",color:"#fff",disabled:!0,roll_back_text:"下一步"});var e=this.getInputVal();$.post("/console/api/account/verify",{code:e,tim:Math.random()},(function(e){if("success"==e.status)n.redirect();else{$(".safe-form-content").find(".error-message").html('<i class="mdi-icon-warning"></i> '+e.message);var t=$("#verify-safe-form").find("input");t.addClass("form-error"),t.parent().addClass("shake"),setTimeout((()=>{t.parent().removeClass("shake")}),500),$(".safe-form-content").find("button[type=submit]").spinner("destory")}}))}}},t={hmcsuccess:!1,code_info:{isPending:!1,hasSend:!1,startTime:60,text:"获取验证码",timer:""},init:function(){t.code_info.hasSend||t.init_code(),$(".forget-password").hide(),$(".code-wrap").on("click",(function(){if(!t.code_info.isPending&&!t.code_info.hasSend){var e=$("#login-form-code").find("input[name=mob]"),n=e.val();$(".type-1").find(".error-message").empty();/^1[3,4,5,6,7,8,9][0-9]{9}$/.test(n)?$("#msg-hmc").show(0,(function(){t.hmc.init($("#msg-hmc mdi-hmc")),$("#msg-hmc mdi-hmc").hmc("reset"),t.change_code_text("请进行滑块验证...","text")})):(e.addClass("form-error"),e.parent().append('<label id="'+e.attr("name")+'-error" for="'+e.attr("name")+'" class="form-error">请输入正确手机号</label>'))}})),$("#login-form-code").validate({rules:{mob:{required:!0,digits:!0,minlength:11,maxlength:11},code:{required:!0,minlength:6,maxlength:6}},messages:{mob:{required:"请输入手机号",digits:"请输入正确手机号",minlength:"请输入正确手机号",maxlength:"请输入正确手机号"},code:{required:"请输入验证码",minlength:"请输入验证码",maxlength:"请输入验证码"}},invalidHandler:function(){return!1},submitHandler:function(){return t.hmcsuccess?t.do_login():$("#msg-hmc mdi-hmc").hmc("focus"),!1}})},hmc:{init:function(e){e.hmc({init:function(){t.hmcsuccess=!1},callback:function(){t.hmcsuccess=!0,t.get_code()}})}},init_code:function(){t.code_info.isPending=!1,t.code_info.hasSend=!1,t.code_info.startTime=60,t.change_code_text("获取验证码"),t.code_info.timer&&clearInterval(t.code_info.timer)},change_code_text:function(e,n="pointer"){$(".code-wrap").empty().append(e).css("cursor",n)},get_code:function(){t.code_info.isPending=!0,t.change_code_text("正在发送...","text"),$(".type-1").find(".error-message").empty();var e=$(".type-1").find("input[name=mob]").val();$.post("/console/api/account/send_sms_login_verify_code",{tim:Math.random(),mob:e},(function(e){t.code_info.isPending=!1,t.code_info.hasSend=!0,t.code_info.timer&&clearInterval(t.code_info.timer),"success"==e.status?($(".code-wrap").css("cursor","text"),t.code_info.timer=setInterval((()=>{if(t.code_info.startTime<=1)return t.init_code(),void t.change_code_text("重新发送");t.code_info.startTime-=1;var e=`重新获取验证码(${t.code_info.startTime}s)`;t.change_code_text(e,"text")}),1e3)):"error"==e.status?($(".type-1").find(".error-message").html('<i class="mdi-icon-warning"></i> '+e.message),t.init_code(),t.change_code_text("重新发送"),$("#msg-hmc mdi-hmc").hmc("reset")):($.dialog.alert({type:"warning",title:"抱歉！发生了一个错误",content:e.message}),t.init_code(),t.change_code_text("重新发送"),$("#msg-hmc mdi-hmc").hmc("reset"))}))},do_login:function(){var e=$("#login-form-code").find("input[name=mob]").val(),n=$("#login-form-code").find("input[name=code]").val();$(".type-1").find(".error-message").empty(),$("#login-form-code").find("button.code-submit[type=submit]").spinner({text:"正在验证 ...",type:"grow",size:"s",color:"#fff",disabled:!0,roll_back_text:"登录"}),$.post("/console/api/account/sms_login",{tim:Math.random(),mob:e,verify_code:n},(function(e){if("success"==e.status)$.cookie("submail_account",e.account),$.cookie("last_login_at",e.last_login_at),t.redirect();else{if("此用户未注册"==e.message)return void(window.location.href="/registered_sms");if(e.type){if($(".type-1").find(".error-message").html('<i class="mdi-icon-warning"></i> '+e.message),"verify_code"==e.type){var n=$("#login-form-code").find("input[name=code]");n.addClass("form-error"),n.parent().addClass("shake"),n.parent().find("label.form-error").remove(),n.parent().append('<label id="'+n.attr("name")+'-error" for="'+n.attr("name")+'" class="form-error">'+e.message+"</label>"),setTimeout((()=>{n.parent().removeClass("shake")}),500)}}else $.dialog.alert({type:"warning",title:"抱歉！发生了一个错误",content:e.message});$("#login-form-code").find("button[type=submit]").spinner("destory")}}))},redirect:function(){null!=redirct_url&&""!=redirct_url?window.location=redirct_url:window.location="/console/welcome"}};function i(i){e=i,$(".login-tabs .tab-item").removeClass("active"),$(".login-tabs").find(`.tab-item:eq(${i})`).addClass("active"),0==i?($(".login-tabs .bg").css("left",0),$(".type-1").hide(),$(".type-0").show(),setTimeout((()=>{n.init()}),1e3)):($(".login-tabs .bg").css("left","calc(50% - 4px)"),$(".type-0").hide(),$(".type-1").show(),setTimeout((()=>{t.init()}),1e3))}$(".login-tabs").on("click",".tab-item",(function(n){var t=$(this).index();e!=t&&i(t)})),i(0),$(document).on("click",".return-form",(function(){$(".login-form-content").show(),$(".safe-form-content").hide(),$("mdi-hmc").hmc("reset"),$("#login-form-password").find("button[type=submit]").spinner("destory")}))}));